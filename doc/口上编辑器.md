# 🛠️ Pera 口上制作工坊 (Kojo Maker) 使用手册

欢迎来到 **Pera 口上制作工坊**！
这里不需要你死记硬背复杂的代码语法，也不需要担心缩进错误。你只需要点点鼠标，选选菜单，就能生成可以在游戏中运行的剧情脚本。

---

## 1. 🚀 如何启动

1.  **运行游戏**：首先启动 `main.py` 进入游戏。
2.  **输入指令**：在游戏的输入框中输入 `kojo_maker`（或者你在事件中设置的其他触发词），然后回车。
3.  **等待窗口**：稍等片刻，一个独立的图形化编辑窗口就会弹出。

> **小贴士**：制作器启动时会自动读取游戏当前的所有数据（如角色属性名、已注册的立绘、现有的事件列表），所以请确保你的 CSV 文件和图片文件夹是正常的。

---

## 2. 🖥️ 界面概览

编辑器分为三个主要区域：

### A. 顶部工具栏 (Toolbar)
*   **📄 新建工程**：清空当前所有内容，重新开始。
*   **💾/📂 保存/打开工程 (JSON)**：这是制作器的**专用存档格式**。如果你没写完，或者想以后修改，请保存为 JSON。
*   **➕ 新建差分 (Root)**：添加一个新的事件入口（详见下文）。
*   **🧩 插入模板**：把别的 JSON 文件里的内容“嫁接”到你现在的逻辑里（超好用！）。
*   **🚀 导出脚本 (.py)**：这是最后一步，生成游戏真正能读取的 Python 代码文件。

### B. 左侧：逻辑树 (Logic Tree)
这里显示你的剧情流程。它像文件夹目录一样，层层递进。
*   **右键点击**任意节点，可以弹出菜单进行**添加子节点**或**删除**操作。

### C. 右侧：属性编辑区 (Editor)
当你点击左侧的某个节点时，这里会显示该节点的详细设置（比如修改对话内容、设置判断条件）。

---

## 3. 🧱 核心概念：节点 (Node)

在制作器里，一切都是**节点**。我们要做的就是把不同的节点拼在一起。

### 1. 📦 根节点 (Root / 差分)
*   **是什么**：每一个根节点代表一个独立的**事件函数**。
*   **怎么用**：一个脚本文件里可以有多个根节点。比如你写“灵梦的聊天口上”，可以创建两个根节点：
    *   `1_初期_聊天_日常` (日常对话)
    *   `1_初期_聊天_好感` (好感高时的特殊对话)
*   **关键设置**：**事件ID**。这是游戏找到这段剧情的唯一凭证，千万别写错！

### 2. 🔷 分支判断 (Branch / IF)
*   **是什么**：就是“如果...那么...”。
*   **设置方法**：
    1.  **变量类型**：选择你要判断什么数据。
        *   `SYS`：系统数据（如当前指令 `SELECTCOM`，当前对象 `TARGET`）。
        *   `ABL` / `TALENT` / `BASE`：角色的具体属性。
    2.  **对象 (Scope)**：*（选择 SYS 时隐藏）*
        *   选 `TARGET`：判断当前对话对象的数据。
        *   选 `MASTER`：判断主角的数据。
        *   选 `1`、`2`...：判断特定 ID 角色的数据。
    3.  **变量名**：选择具体的属性（如“顺从”、“体力”）。
    4.  **符号与数值**：比如 `>` `0`，或者 `==` `1`。
*   **生成的逻辑**：`如果 (对象) 的 (属性) (大于/等于) (数值)，则执行下面的子节点`。

### 3. 💬 文本 (Text)
*   **是什么**：游戏屏幕上显示的字。
*   **快捷插入**：点击上方的【主角】、【对象】按钮，可以在文本里插入 `{master_name}` 等标签，游戏运行时会自动替换成名字。
*   **颜色**：默认为 `COL_TALK` (白色)，你可以改为 `COL_DESC` (灰色描述) 或 `(255, 0, 0)` (红色)。

### 4. 🖼️ 图片 (Image)
*   **是什么**：在对话中插入一张立绘。
*   **怎么用**：下拉菜单里会自动列出游戏里所有已注册的图片，选中即可。

### 5. 🔗 调用 (Call)
*   **是什么**：触发另一个事件。
*   **场景**：比如聊完天后，想触发“增加好感度”的通用处理事件。

---

## 4. 🎓 快速上手教程：制作第一个口上

假设我们要给 **ID为1** 的角色（灵梦）写一个 **聊天** 事件。

**步骤 1：准备工作**
1.  点击 **➕ 新建差分 (Root)**。
2.  在右侧编辑 **事件ID**：`1_初期_聊天`。
3.  点击 **保存设置**。

**步骤 2：写逻辑 (好感度判定)**
1.  在左侧树上，右键点击根节点 -> **➕ 添加分支判断**。
2.  左键选中新出的 `[IF]` 节点。
3.  在右侧设置：
    *   类型选 `CFLAG`（假设好感度在这里）。
    *   对象选 `TARGET`（对方）。
    *   变量名选 `好感度`。
    *   符号选 `>=`，数值填 `100`。
4.  点击 **保存条件**。

**步骤 3：写对话**
1.  **情况 A：好感高**
    *   右键点击刚才的 `[IF] 好感度>=100` 节点 -> **📝 添加文本**。
    *   选中新出的 `[文本]` 节点。
    *   内容写：“{target_name}红着脸看着{master_name}……”。
    *   点击 **保存文本**。
2.  **情况 B：普通 (Else)**
    *   (Pera 制作器暂时通过平级 IF 实现 Else，或者直接在 IF 后面加通用文本)
    *   我们可以再加一个分支：`好感度 < 100`，然后在下面写普通对话。

**步骤 4：导出**
1.  点击顶部绿色的 **🚀 导出脚本**。
2.  保存为 `1_初期_聊天.py`，放入游戏的 `events/` 文件夹。
3.  **搞定！** 重启游戏或使用重载功能，就能看到效果了。

---

## 5. 🧩 进阶技巧：模板复用

你写了一个很复杂的“高潮判定逻辑”（包含体力、感觉、刻印的复杂计算），想给所有角色通用？

1.  **制作模板**：新建一个工程，只写这个判定逻辑树。
2.  **保存**：点击 **💾 保存工程**，存为 `通用_高潮判定.json`。
3.  **复用**：
    *   打开你在写的其他角色口上。
    *   选中你想插入判定的位置。
    *   点击顶部 **🧩 插入模板**，选择刚才的 JSON。
    *   **啪！** 以前写好的几百行逻辑瞬间复制过来了！

---

## ❓ 常见问题 (FAQ)

**Q: 为什么右边的下拉菜单是空的？**
A: 可能是游戏启动时 CSV 数据没读到。请检查你的 CSV 文件内容是否正确，或者查看控制台是否有报错。

**Q: 我写了 {master_name} 但游戏里没变？**
A: 请确保你是用导出功能生成的 `.py` 文件。因为导出功能会自动在文件头部添加变量定义代码。

**Q: 怎么删除节点？**
A: 右键点击你想删除的节点，选择红色选项 **❌ 删除此节点**。注意：删除父节点会连同子节点一起删除！

**Q: 缩进好像有点乱？**
A: 制作器导出的代码已经经过优化，通常是正确的。如果发现逻辑不对，建议先在左侧树状图里检查层级关系是否正确（是不是把该在 IF 外面的话写到 IF 里面去了）。