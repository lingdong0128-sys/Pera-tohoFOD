

---

# 🛠️ Pera Kojo Converter (PKC) 用户手册

**Pera 口上搬迁助手** 是一款专为 Pera 框架设计的辅助工具，旨在将传统的 ERA 游戏脚本（ERB 格式）半自动化地转换为 Python 格式的事件代码。

## 🌟 核心功能

1.  **多函数自动拆分**：能够识别 ERB 文件中的多个 `@FUNCTION_NAME`，并将其拆分为独立的 Python 函数。
2.  **变量智能映射**：自动将 `TALENT:恋慕`、`BASE:体力` 等 ERA 变量转换为 Pera 的 `kojo.TALENT.get('恋慕')` 调用。
3.  **控制流转换**：
    *   `IF / ELSEIF / ELSE` -> `if / elif / else`
    *   `SELECTCASE` -> `if / elif / else` (带临时变量)
    *   `CALL` -> `trigger_event`
4.  **运算符翻译**：自动将 C 风格运算符 (`&&`, `||`, `!`) 转换为 Python 风格 (`and`, `or`, `not`)。
5.  **人工介入模式**：遇到复杂的 `GOTO`、`DATALIST` 或无法解析的语句时，会弹窗询问用户如何处理，防止转换中断。

---

## 🚀 使用指南

### 1. 启动工具
在项目根目录下运行：
```bash
python tools/转化器.py
```

### 2. 加载与转换
1.  点击 **"1. 加载 ERB 文件"**，选择你要搬迁的 `.erb` 文件。
2.  点击 **"2. 开始转换"**。
3.  **处理弹窗**：如果代码中有复杂逻辑，工具会暂停并弹窗。你可以选择：
    *   **注释掉**：生成的代码中会以 `# [TODO]` 注释该行。
    *   **跳过**：生成 `pass`。
    *   **手动输入**：直接在弹窗里写 Python 代码替代。
4.  检查右侧生成的代码，确认无误后点击 **"3. 保存"**。

### 3. 后续处理
生成的 `.py` 文件通常还需要进行以下微调：
*   **缩进检查**：虽然大幅优化了缩进，但在多层嵌套的 `SELECTCASE` 中仍可能出现对齐问题。
*   **触发器设置**：文件末尾的 `event_trigger` 默认使用原函数名，你可能需要根据 Pera 的命名规范（如 `角色ID_口上类型_功能`）进行修改。

---

## ⚠️ 功能边界与限制

PKC 并不是一个全能的编译器，它本质上是一个**高级正则替换工具**。以下情况它无法完美处理：

### 1. 复杂的 `DATALIST` / `INPUT`
ERA 中的 `DATALIST` 用于生成复杂的列表选项。
*   **PKC 行为**：弹窗报错。
*   **建议**：手动重写为 Pera 的 `this.console.PRINT` 和 `click` 事件。

### 2. 位运算与 `GETBIT`
虽然工具尝试处理 `GETBIT`，但复杂的位操作（如 `SETBIT`）可能无法自动转换。
*   **建议**：手动检查所有涉及位运算的逻辑。

### 3. 动态变量名
例如 `TALENT:ARG:0`（ARG 是参数）。
*   **PKC 行为**：可能将其解析为字符串 `'ARG'` 而不是变量。
*   **建议**：手动修改为 `kojo.TALENT[arg_variable].get(...)`。

### 4. `GOTO` 跳转
Python 不支持 `GOTO`。
*   **PKC 行为**：弹窗报错。
*   **建议**：重构逻辑，使用 `while` 循环或函数调用替代。

---

## 🐛 已知问题：缩进

尽管引入了“先生成后缩进”的机制来修复 `SELECTCASE` 的问题，但在以下极端情况下，缩进仍可能出错：

### 情况 A：混合嵌套
```erb
IF 条件A
    SELECTCASE 变量
        CASE 1
            IF 条件B
                ...
            ENDIF
    ENDSELECT
ENDIF
```
**表现**：深层嵌套的 `ENDIF` 或 `ENDSELECT` 可能导致缩进回退过多或过少。
**解决**：在保存前，务必肉眼检查右侧预览框的缩进线。

### 情况 B：单行 IF
```erb
SIF 条件A
    PRINT 文本
```
**表现**：PKC 目前主要针对 `IF ... ENDIF` 块结构。`SIF`（单行 IF）可能会导致后续代码缩进错误。
**解决**：工具会尝试将其转换为 `if 条件: 语句`，但如果遇到复杂的单行逻辑，建议手动调整。

---

## 📝 最佳实践

1.  **小步快跑**：不要一次性转换几万行的巨型 ERB。如果是大文件，建议先拆分成几个小文件分别转换，最好的解决方案是一个个差分进行转换。
2.  **人工复核**：转换后的代码**必须**经过人工阅读。特别是涉及游戏数值修改（如 `CFLAG` 赋值）的地方。
3.  **利用中间层**：生成的代码依赖 `utils.era_handler`。如果你发现生成的代码报错说找不到属性，请检查你的 `EraKojoHandler` 类是否更新到了最新版本。