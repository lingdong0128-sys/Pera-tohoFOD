

---

# ğŸ“˜ Pera Framework: `allstate` æ•°æ®ç»“æ„ä¸è°ƒç”¨å¤§å…¨

**`allstate` æ˜¯ä»€ä¹ˆï¼Ÿ**
å®ƒæ˜¯æ¸¸æˆè¿è¡Œæ—¶æ‰€æœ‰è§’è‰²çš„**çŠ¶æ€å¿«ç…§ (Snapshot)**ã€‚
ä¸åŒäº `init.charaters_key`ï¼ˆå­˜æ”¾åŸå§‹ CSV å­—ç¬¦ä¸²æ•°æ®ï¼‰ï¼Œ`allstate` æ˜¯ç»è¿‡æ¸…æ´—ã€ç±»å‹è½¬æ¢ï¼ˆè½¬ä¸º intï¼‰ã€åˆ†ç±»æ•´ç†åçš„**é«˜æ€§èƒ½å­—å…¸**ï¼Œä¸“ä¾›é€»è¾‘åˆ¤æ–­å’Œ UI æ˜¾ç¤ºä½¿ç”¨ã€‚

---

## 1. æ•°æ®ç»“æ„æ€»è§ˆ

`this.console.allstate` çš„ç»“æ„å¦‚ä¸‹ï¼ˆä»¥ JSON æ ¼å¼å±•ç¤ºï¼‰ï¼š

```json
{
  "0": {  // --- ä¸»è§’ (Master) ---
    "id": "0",
    "name": "ä½ ",
    "callname": "ä½ ",
    "fullname": "ä½ ",
    
    // åŸå§‹æ•°æ®å¼•ç”¨ (ç›´æ¥æŒ‡å‘ init.charaters_key['0'])
    // ä¿®æ”¹è¿™é‡Œç­‰åŒäºä¿®æ”¹åº•å±‚æ•°æ®
    "data": { ... }, 

    // å±æ€§ (åŸºç¡€ BASE + èƒ½åŠ› ABL) - æ•°å€¼å‹
    "attributes": {
        "ä½“åŠ›": 1500,
        "æ°”åŠ›": 1000,
        "æ€§æŠ€": 2,
        "Cæ„Ÿè§‰": 1,
        // ...
    },

    // ç´ è´¨ (TALENT) - æ•°å€¼å‹
    "talents": {
        "æ€§åˆ«": 1,
        "å¤„å¥³": 0,
        "æ‹æ…•": 1,
        // ...
    },

    // CFLAG (ç‰¹æ®Šæ ‡å¿—)
    "cflags": {
        2: 1,      // æ¯”å¦‚ï¼šç¡çœ æ·±åº¦
        "å¥½æ„Ÿåº¦": 500
    },

    // è£…å¤‡æ 
    "equip": {
        "ä¸Šè¡£": "æ— ",
        "ä¸‹è¡£": "æ— ",
        "å†…è¡£": "æ— ",
        "è£…é¥°": "æ— "
    },

    // è¿è¡Œæ—¶çŠ¶æ€ (éæ°¸ä¹…ï¼Œå¦‚æˆ˜æ–—ä¸­/Hä¸­çŠ¶æ€)
    "states": {
        "æ€€å­•": 0,
        "ç™ºæƒ…": 0,
        "ç»é¡¶": 0
    },

    // ç«‹ç»˜æ¸²æŸ“ä¿¡æ¯ (é¢„è®¡ç®—å¥½çš„)
    "portrait": {
        "current_type": "åˆå§‹ç»˜",
        "current_face": "é¡”çµµ_æœ_é€šå¸¸",
        "full_key": "0_åˆå§‹ç»˜_é¡”çµµ_æœ_é€šå¸¸_0", // ç›´æ¥ä¼ ç»™ PRINTIMG åˆ—è¡¨
        "available": ["ç«‹ç»˜", "è¡¨æƒ…ç»˜"]
    }
  },

  "1": { ... } // --- è§’è‰² 1 (çµæ¢¦) ---
}
```

---

## 2. è°ƒç”¨æ–¹å¼å¤§å…¨

åœ¨ä»»ä½•äº‹ä»¶ (`event_*.py`) ä¸­ï¼Œä½ éƒ½å¯ä»¥é€šè¿‡ `this` è®¿é—®åˆ°å®ƒã€‚

### A. åŸºç¡€è®¿é—®

```python
# 1. è·å–æ•´ä¸ªå¤§å­—å…¸
all_states = this.console.allstate

# 2. è·å–ç‰¹å®šè§’è‰²çš„çŠ¶æ€ (ä¾‹å¦‚ ID '1')
reimu = all_states.get('1') 

# 3. è·å–ä¸»è§’çŠ¶æ€
master = all_states.get('0')
```

### B. å¸¸ç”¨å±æ€§è¯»å– (Read)

```python
chara = this.console.allstate['1']

# --- åå­— ---
print(chara['name'])       # -> "åšä¸½ çµæ¢¦"
print(chara['callname'])   # -> "çµæ¢¦"

# --- å±æ€§åˆ¤æ–­ (ä¸ç”¨å† int() è½¬æ¢äº†) ---
if chara['attributes'].get('ä½“åŠ›', 0) > 500:
    print("ä½“åŠ›å……æ²›")

# --- ç´ è´¨åˆ¤æ–­ ---
if chara['talents'].get('æ‹æ…•'):
    print("å¥¹å–œæ¬¢ä½ ")

# --- CFLAG è¯»å– ---
# æ³¨æ„ï¼šstate_builder ä¼šå°è¯•æŠŠæ•°å­—é”®è½¬ä¸º intï¼Œä½†ä¹Ÿä¿ç•™å­—ç¬¦ä¸²é”®
favor = chara['cflags'].get('å¥½æ„Ÿåº¦', 0)
event_flag = chara['cflags'].get(1001, 0) # è¯»å– CFLAG:1001

# --- ç«‹ç»˜è°ƒç”¨ ---
# ç›´æ¥æ‹¿æ¥ç”»å›¾
img_key = chara['portrait']['full_key']
this.console.PRINTIMG(None, img_list=[img_key])
```

### C. æ•°æ®ä¿®æ”¹ (Write)

**æ³¨æ„**ï¼š`allstate` æ˜¯å†…å­˜ä¸­çš„ç¼“å­˜ã€‚
*   å¯¹äº **`data`** å­—æ®µï¼šå®ƒæ˜¯å¼•ç”¨ï¼Œä¿®æ”¹å®ƒä¼šç›´æ¥åŒæ­¥åˆ°åº•å±‚ CSV ç¼“å­˜ã€‚
*   å¯¹äº **`attributes`** ç­‰å­—æ®µï¼šä¿®æ”¹å®ƒåªä¼šæ”¹å˜å½“å‰æ¸¸æˆçš„è¿è¡ŒçŠ¶æ€ï¼ˆè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼‰ã€‚

```python
target = this.console.allstate['1']

# 1. æ‰£é™¤ä½“åŠ›
target['attributes']['ä½“åŠ›'] -= 100

# 2. å¢åŠ å¥½æ„Ÿåº¦ (å‡è®¾å­˜åœ¨ cflags ä¸­)
# æ¨èå†™æ³•ï¼šå…ˆå–å€¼ï¼ŒåŠ å®Œå†™å›
current_favor = target['cflags'].get('å¥½æ„Ÿåº¦', 0)
target['cflags']['å¥½æ„Ÿåº¦'] = current_favor + 50

# 3. è·å¾—ç´ è´¨
target['talents']['æ‹äºº'] = 1

# 4. æ›´æ”¹ç«‹ç»˜çŠ¶æ€
# ä¿®æ”¹åŸå§‹æ•°æ®ï¼Œä¸‹æ¬¡ build_state æ—¶ä¼šé‡æ–°è®¡ç®— full_key
target['data']['draw_type'] = 'åˆå§‹ç»˜'
target['data']['DrawName'] = 'é¡”çµµ_è£¸_å‘æƒ…'
# å¦‚æœæƒ³ç«‹å³ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹ç¼“å­˜ä¸­çš„ full_keyï¼Œæˆ–è€…è§¦å‘ä¸€æ¬¡ build_state
```

---

## 3. é…åˆ `get_context` ä½¿ç”¨

å¦‚æœä½ åœ¨äº‹ä»¶ä¸­è°ƒç”¨äº† `get_context`ï¼Œ`allstate` çš„æ•°æ®å·²ç»è¢«æ‰“åŒ…åœ¨ `ctx['master']` å’Œ `ctx['chara']` é‡Œäº†ã€‚

```python
def event_test(this):
    # è·å–ä¸Šä¸‹æ–‡
    ctx = this.event_manager.trigger_event('get_context', this)
    
    # ç›´æ¥ç”¨ï¼Œæ›´çŸ­æ›´æ–¹ä¾¿
    master = ctx['master']
    target = ctx['chara']
    
    this.console.PRINT(f"{master['name']} çœ‹ç€ {target['name']}...")
    
    if target['attributes']['æ°”åŠ›'] < 100:
        this.console.PRINT("å¥¹çœ‹èµ·æ¥å¾ˆç´¯ã€‚")
```

---

## 4. å¸¸è§é—®é¢˜ (FAQ)

**Q: ä¸ºä»€ä¹ˆæŠ¥é”™ `'NoneType' object is not subscriptable`?**
A: ä½ å¯èƒ½åœ¨æ¸¸æˆåˆšå¯åŠ¨ã€è¿˜æ²¡è¿è¡Œ `build_state` çš„æ—¶å€™å°±å»è®¿é—®äº† `this.console.allstate['0']`ã€‚
**è§£å†³**ï¼š
```python
if not getattr(this.console, 'allstate', None):
    this.event_manager.trigger_event('build_state', this)
```

**Q: æˆ‘åœ¨ `allstate` é‡Œæ”¹äº†ä½“åŠ›ï¼Œä¸ºä»€ä¹ˆè¯»æ¡£åæ²¡å˜ï¼Ÿ**
A: `allstate` æ˜¯è¿è¡Œæ—¶å†…å­˜ã€‚å­˜æ¡£æ—¶ï¼ˆä½¿ç”¨ `SaveSystem`ï¼‰ï¼Œæˆ‘ä»¬ä¼šæŠŠ `allstate` ä¿å­˜è¿› JSONã€‚è¯»æ¡£æ—¶ï¼Œ`apply_save` äº‹ä»¶ä¼šæŠŠ JSON æ•°æ®è¦†ç›–å› `allstate`ã€‚
**åªè¦ä½ çš„å­˜æ¡£ç³»ç»Ÿä¿å­˜äº† `state_dict`ï¼Œä¿®æ”¹å°±æ˜¯æœ‰æ•ˆçš„ã€‚**

**Q: æˆ‘åœ¨ `allstate` é‡ŒåŠ äº†ä¸ªæ–°å­—æ®µ `target['temp_flag'] = 1`ï¼Œä¼šæŠ¥é”™å—ï¼Ÿ**
A: ä¸ä¼šã€‚Python å­—å…¸æ˜¯åŠ¨æ€çš„ï¼Œä½ å¯ä»¥éšä¾¿å¾€é‡Œå¡ä¸´æ—¶æ•°æ®ã€‚è¿™äº›æ•°æ®åœ¨å­˜æ¡£æ—¶ä¹Ÿä¼šè¢«è‡ªåŠ¨å­˜è¿›å»ï¼ˆåªè¦å®ƒä»¬æ˜¯åŸºç¡€ç±»å‹ int/str/list/dictï¼‰ã€‚

---

## 5. å¿«é€Ÿé€ŸæŸ¥è¡¨ (Cheatsheet)

| æ•°æ®ç±»å‹ | Pera è®¿é—®è·¯å¾„ (chara = allstate[id]) | å¯¹åº” ERB å†™æ³• |
| :--- | :--- | :--- |
| **åå­—** | `chara['name']` | `%NAME:TARGET%` |
| **åŸºç¡€å±æ€§** | `chara['attributes']['ä½“åŠ›']` | `BASE:TARGET:0` / `BASE:ä½“åŠ›` |
| **èƒ½åŠ›ç­‰çº§** | `chara['attributes']['Cæ„Ÿè§‰']` | `ABL:TARGET:Cæ„Ÿè§‰` |
| **ç´ è´¨(0/1)** | `chara['talents'].get('æ‹æ…•')` | `TALENT:TARGET:æ‹æ…•` |
| **æ ‡å¿—ä½** | `chara['cflags'].get(10)` | `CFLAG:TARGET:10` |
| **ç«‹ç»˜é”®** | `chara['portrait']['full_key']` | (ERBé€šå¸¸æ‰‹åŠ¨æ‹¼æ¥èµ„æºå) |
| **æºæ•°æ®** | `chara['data']['xxx']` | (ç›´æ¥è®¿é—® CSV åŸå§‹å€¼) |