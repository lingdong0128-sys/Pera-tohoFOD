
---

# 🗺️ Pera 框架变量映射手册 (ERB ⟺ Python)

本文档描述了如何通过 `EraKojoHandler` (通常在代码中实例化为 `kojo`) 来访问和修改游戏数据。

> **核心原则**：
> 1.  ERB 中的 **冒号 (`:`)** 调用通常转换为 Python 的 **`.get()`** 或 **字典索引**。
> 2.  所有从 CSV 读取的数据默认都是 **字符串**，进行数值计算前请使用 `int()`。
> 3.  `kojo` 对象会自动绑定当前的 `TARGET`，除非显式指定角色 ID。

## 1. 基础系统变量

| ERB 变量 | Python 调用 (`kojo`) | 描述 |
| :--- | :--- | :--- |
| `MASTER` | `kojo.MASTER` | 返回主角的 ID (字符串)，通常为 `'0'` |
| `TARGET` | `kojo.TARGET` | 返回当前交互对象的 ID (字符串) |
| `PLAYER` | `kojo.PLAYER` | 返回当前执行动作的角色 ID |
| `ASSI` | `kojo.ASSI` | 返回助手 ID 列表 (List) |
| `SELECTCOM` | `kojo.SELECTCOM` | 当前选择的指令编号 |
| `PREVCOM` | `kojo.PREVCOM` | 上一次选择的指令编号 |
| `CHARANUM` | `kojo.CHARANUM` | 游戏中已注册角色的总数 |
| `RAND:x` | `kojo.Rand(x)` | 返回 0 到 x-1 的随机整数 |

## 2. 角色数据访问 (Charaters Key)

这些变量通过 `EraDataProxy` 代理访问。
*   **默认访问**：访问当前 `TARGET` 的数据。
*   **指定访问**：访问特定 ID 角色的数据。

### 常用属性表

| ERB 写法 (示例) | Python 写法 (推荐) | 对应 CSV 分类 | 备注 |
| :--- | :--- | :--- | :--- |
| `BASE:体力` | `kojo.BASE.get('体力')` | `基础` | 基础属性 |
| `MAXBASE:体力` | `kojo.MAXBASE.get('体力')` | `基础上限` | 属性上限 |
| `ABL:C感觉` | `kojo.ABL.get('C感觉')` | `能力` | 能力等级 |
| `TALENT:恋慕` | `kojo.TALENT.get('恋慕')` | `素質` | 素质/天赋 (0/1) |
| `EXP:绝顶经验` | `kojo.EXP.get('绝顶经验')` | `经验` | 经验数值 |
| `MARK:反发刻印` | `kojo.MARK.get('反发刻印')` | `刻印` | 刻印等级 |
| `CFLAG:好感度` | `kojo.CFLAG.get('好感度')` | `CFLAG` | 角色标志位 |
| `EQUIP:下衣` | `kojo.EQUIP.get('下衣')` | `装备` | 装备状态 |
| `JUEL:快感` | `kojo.JUEL.get('快感')` | `珠` | 宝珠数量 |
| `TCVAR:0` | `kojo.TCVAR.get('0')` | `TCVAR` | 临时角色变量 |

### 访问示例

**读取当前 TARGET 的体力：**
```python
# ERB: BASE:体力
current_stamina = int(kojo.BASE.get('体力', 0))
```

**读取主角 (MASTER) 的技巧：**
```python
# ERB: ABL:MASTER:技巧
master_tech = int(kojo.ABL[kojo.MASTER].get('技巧', 0))
```

**修改数据 (写操作)：**
```python
# ERB: CFLAG:好感度 += 100
current = int(kojo.CFLAG.get('好感度', 0))
kojo.CFLAG.set('好感度', current + 100)
```

## 3. 角色属性 (直接属性)

| ERB 变量 | Python 调用 | 描述 |
| :--- | :--- | :--- |
| `NO:TARGET` | `kojo.NO` | 返回当前角色在 chara_ids 列表中的索引 |
| `NAME:TARGET` | `kojo.NAME` | 返回角色的全名 (`名前`) |
| `CALLNAME:TARGET` | `kojo.CALLNAME` | 返回角色的称呼 (`呼び名`) |
| `RELATION:ID` | `kojo.RELATION('ID')` | 查询当前 TARGET 对某 ID 角色的相性 |

## 4. 事件上下文与计算 (Context)

这些数据通常由 `聊天` 或 `调教` 主循环在每一回合动态生成，并传递给口上。

| ERB 变量 | Python 调用 | 描述 |
| :--- | :--- | :--- |
| `PALAM:润滑` | `kojo.PALAM.get('润滑')` | 当前回合的参数值 |
| `UP:欲情` | `kojo.UP.get('欲情')` | 本回合上升的参数量 |
| `DOWN:体力` | `kojo.DOWN.get('体力')` | 本回合下降的参数量 |
| `LOSEBASE:体力` | `kojo.LOSEBASE.get('体力')` | 本回合消耗的基础值 |
| `TEQUIP:眼罩` | `kojo.TEQUIP.get('眼罩')` | 当前生效的装备/状态效果 |
| `EX:C绝顶` | `kojo.EX.get('C')` | 本回合绝顶次数 |
| `STAIN:口` | `kojo.STAIN.get('口')` | 污渍状态 (Pera中通常为列表) |

## 5. 全局名称与定义 (Global Key)

这些是从 `csv/global/*.csv` 加载的只读字典，用于查询 ID 对应的名称。

| ERB 变量 | Python 调用 | 对应 CSV |
| :--- | :--- | :--- |
| `BASENAME:0` | `kojo.BASENAME.get('0')` | `Base.csv` |
| `ABLNAME:0` | `kojo.ABLNAME.get('0')` | `Abl.csv` |
| `TALENTNAME:0`| `kojo.TALENTNAME.get('0')`| `Talent.csv` |
| `EXPNAME:0` | `kojo.EXPNAME.get('0')` | `Exp.csv` |
| `ITEMNAME:0` | `kojo.ITEMNAME.get('0')` | `Item.csv` |
| `STR:0` | `kojo.STR.get('0')` | `Str.csv` |

## 6. 物品与背包系统

| ERB 变量 | Python 调用 | 描述 |
| :--- | :--- | :--- |
| `ITEM:0` | `kojo.ITEM.get('0')` | 获取背包中 ID 为 0 的物品数量 |
| `ITEMSALES:0` | `(需自行扩展)` | 物品是否可售卖状态 |

---

## 💡 开发小贴士

1.  **容错处理**：
    Pera 的 `get()` 方法非常安全。如果 CSV 里漏写了某个属性，`kojo.BASE.get('体力', 0)` 会返回 `0` 而不是报错崩溃。这比 ERB 直接报错要友好得多。

2.  **类型转换**：
    时刻记住 `int()`。
    *   ❌ 错误：`if kojo.CFLAG.get('好感度') > 100:` (字符串和数字比较会出错)
    *   ✅ 正确：`if int(kojo.CFLAG.get('好感度', 0)) > 100:`

3.  **调试输出**：
    在口上开发中，可以使用 `this.console.PRINT(f"DEBUG: {kojo.NAME} 好感度={...}")` 来实时查看变量值。